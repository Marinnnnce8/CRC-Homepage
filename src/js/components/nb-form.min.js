/*! NBkit - Form | @version 1.0.2 | @author NB Communication Ltd <info@nbcommunication.com> | @copyright 2020 */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i(require("uikit"),require("nbkit")):"function"==typeof define&&define.amd?define("nbkitform",["uikit","nbkit"],i):(t="undefined"!=typeof globalThis?globalThis:t||self).NBkitForm=i(t.UIkit,t.NBkit)}(this,(function(t,i){"use strict";return UIkit.component("nbForm",{args:"msgConfirm",props:["msgConfirm"],data:{button:null,buttonText:"",captcha:null,response:"",scroller:null,status:0},beforeConnect:function(){i.util.profilerStart("NBkit.Form.beforeConnect");var e=this.$el,r=t.util.$("input[type=hidden]._post_token",e);if(r){var o=function(i){t.util.attr(r,"name",i.tokenName),t.util.attr(r,"value",i.tokenValue)},n=i.util.hasStorage?sessionStorage.getItem("CSRF"):"";if(n)try{o(JSON.parse(n))}catch(t){}else i.util.graphql("{CSRF {tokenName tokenValue}}").then((function(t){200===t.status&&(n=t.response.CSRF,o(n),i.util.hasStorage&&sessionStorage.setItem("CSRF",JSON.stringify(n)))}),t.util.noop)}this.scroller=t.util.$(i.util.attrs({hidden:!0},"div",!0)),t.util.append(e,this.scroller),i.util.profilerStop("NBkit.Form.beforeConnect")},connected:function(){i.util.profilerStart("NBkit.Form.connected");var e=this,r=this.$el;setTimeout((function(){t.util.trigger(r,"onload",e),i.util.profilerStop("NBkit.Form.connected")}),i.options.duration)},events:{submit:function(e){i.util.profilerStart("NBkit.Form.events.submit"),e.preventDefault(),e.stopPropagation();var r=this.$el,o=[],n=t.util.$$(".nb-form-errors",r);if(n.length&&t.util.remove(n),t.util.$$("input[required], select[required], textarea[required]",r).forEach((function(i){t.util.attr(i,"aria-invalid",!1),t.util.remove(t.util.$(".nb-form-error",i.closest(".nb-form-content")))})),t.util.$$("input[required], select[required], textarea[required]",r).forEach((function(e){if(!e.validity.valid){t.util.attr(e,"aria-invalid",!0);var n=t.util.attr(e,"title");n||(n=e.validationMessage);var l=e.id,u=l?t.util.$("label[for="+l+"]",r):null;n=i.util.punctuateString(n),o.push(i.util.link("#"+(l||r.id),(u?u.innerHTML+": ":"")+n,{class:"uk-link-reset",dataUkScroll:{duration:i.options.duration,offset:i.options.offset}}));var s=i.util.wrap(n,"uk-text-danger nb-form-error"),a=t.util.$("[role=alert]",e.closest(".nb-form-content"));a?t.util.append(a,s):t.util.before(e,s)}})),o.length)return t.util.trigger(r,"invalid",this),this.reset(),t.util.before(t.util.$(".uk-grid",r),i.util.ukAlert(i.util.wrap(i.util.wrap(o,"li"),"ul"),"danger",["nb-form-errors"])),UIkit.scroll(this.scroller,{duration:i.options.duration,offset:i.options.offset}).scrollTo(r),t.util.on('.nb-form-errors a[href^="#"]',"click",(function(){t.util.$(t.util.attr(this,"href")).focus()})),!1;if(this.button=t.util.$("button[type=submit]",r),this.msgConfirm){var l=this;UIkit.modal.confirm(this.msgConfirm).then((function(){l.send()}),(function(){return!1}))}else this.send();i.util.profilerStop("NBkit.Form.events.submit")}},methods:{complete:function(){var e=this.$el,r=this.response;if(t.util.trigger(e,"complete",this),t.util.isPlainObject(r)){var o=0;if(r.notification&&(i.util.ukNotification(r.notification),o="timeout"in r.notification?r.notification.timeout:i.options.duration),"callback"in r){var n=r.callback,l=null;Array.isArray(n)&&(n=r.callback[0],l=r.callback[1]),n=n.split("."),t.util.isUndefined(l)&&(l=null);for(var u=window[n[0]],s=n.length,a=1;a<s;a++)n[a]in u&&(u=u[n[a]]);if(u.apply(this,l),o=i.options.duration,!0===r.callback[2])return}if("redirect"in r)return r.redirect&&setTimeout((function(){t.util.isString(r.redirect)?window.location.href=r.redirect:window.location.reload()}),o),void this.reset();r=r.message}if(t.util.remove(this.button),this.captcha&&t.util.remove(this.captcha),t.util.$$("input, select, textarea",e).forEach((function(i){t.util.attr(i,"disabled",!0)})),r){var c=t.util.$(".uk-grid",e);t.util.before(c||e,i.util.ukAlert(r,this.status)),UIkit.scroll(this.scroller,{duration:i.options.duration,offset:i.options.offset}).scrollTo(e)}},error:function(e,r){this.status=e,this.response=r,t.util.trigger(this.$el,"error",this),t.util.includes([401,412,500],e)?(this.reset(),UIkit.modal.alert(i.util.ukAlert(r,"danger"))):this.complete()},reset:function(){this.button&&t.util.html(this.button,this.buttonText),this.captcha&&grecaptcha.reset()},send:function(){i.util.profilerStart("NBkit.Form.send");var e=this.$el,r=t.util.attr(e,"method");this.buttonText=t.util.html(this.button),t.util.html(this.button,i.util.ukSpinner(.467)),this.captcha=t.util.$(".g-recaptcha",e),t.util.trigger(e,"beforeSend",this);var o=this;i.util.ajax(e.action,{data:new FormData(e),method:r||"POST"}).then((function(t){o.status=t.status,o.response=t.response,t.response?o.complete():o.error(t.status,"Error"),i.util.profilerStop("NBkit.Form.send")}),(function(t){o.error(t.status,t.response),i.util.profilerStop("NBkit.Form.send")}))}}})}));
