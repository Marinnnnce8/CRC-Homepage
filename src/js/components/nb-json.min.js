/*! NBkit - Json | @version 1.0.2 | @author NB Communication Ltd <info@nbcommunication.com> | @copyright 2020 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("uikit"),require("nbkit")):"function"==typeof define&&define.amd?define("nbkitjson",["uikit","nbkit"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).NBkitJson=e(t.UIkit,t.NBkit)}(this,(function(t,e){"use strict";return UIkit.component("nbJson",{args:"renderData",props:{config:Object,clsMore:String,clsMoreButton:String,error:String,form:String,loadMore:String,message:String,noResults:String,query:String,render:String,renderData:String,variables:Object},data:{count:0,config:{},clsMore:"uk-text-center uk-margin-large-top",clsMoreButton:"uk-button-primary",error:"Error",errors:[],form:null,init:0,initQuery:!1,items:[],loadMore:"More",message:"",noResults:"",query:"",remaining:0,render:"main.renderItems",renderData:"",response:{},selectors:"",start:0,status:0,total:0,variables:{}},beforeConnect:function(){e.util.profilerStart("NBkit.Json.beforeConnect");for(var i=["start","selectors"],r=i.length,s=0,n=void 0;s<r;s++)n=i[s],this.variables[n]&&(this[n]=this.variables[n]);this.init=this.start,this.errors=[this.error],t.util.includes(this.clsMore,"nb-json-more")||(this.clsMore+=" nb-json-more"),t.util.includes(this.clsMoreButton,"uk-button-")&&!t.util.includes(this.clsMoreButton,"uk-button ")&&(this.clsMoreButton+=" uk-button");var o=this;this.form&&t.util.isUndefined(this._connected)&&t.util.on(this.form,"submit reset",(function(t){"submit"===t.type?(t.preventDefault(),t.stopPropagation(),o.get(e.util.formDataEntries(this),this)):o.get("")}));var l=t.util.$$("[data-nb-json-filter]");l.length&&t.util.on(l,"click",(function(e){e.preventDefault();var i=t.util.data(this,"nb-json-filter");t.util.removeClass(l,"uk-active"),i&&t.util.addClass(this,"uk-active"),o.get(i)})),e.util.profilerStop("NBkit.Json.beforeConnect")},connected:function(){e.util.profilerStart("NBkit.Json.connected");var i=this.$el,r=this;if(t.util.on(i,"error",(function(){return t.util.html(i,e.util.ukAlert(r.errors,r.status))})),this.renderData)this.response=e.util.base64Decode(this.renderData),this.parse(),this.count&&(t.util.html(i,this.renderItems()),t.util.trigger(i,"render",this),t.util.trigger(i,"complete",this)),t.util.removeAttr(i,"data-"+this.$name),this.$destroy();else{var s=0;if(this.form)for(var n=t.util.$$("input, select, textarea",t.util.$(this.form)),o=n.length,l=0;l<o;l++)n[l].value&&s++;s?t.util.trigger(r.form,"submit"):this.request()}e.util.profilerStop("NBkit.Json.connected")},events:[{name:"click",delegate:function(){return".nb-json-more button"},handler:function(t){this.request()}}],methods:{get:function(i,r){if(Array.isArray(i)){if(!t.util.isUndefined(r)){for(var s=i,n=s.length,o={},l=function(e,i,r){void 0===r&&(r=""),Array.isArray(e)&&(r=i,i=e.length>1?e[1]:"",e=e[0]),r&&!t.util.includes(e,r)&&(e+=r),t.util.includes(e,"[]")&&(e=e.replace("[]","")),e in o||(o[e]=[]),o[e].push(i)},u=function(i,n,o,u,a,v,b,k){if(n=s[i][1]){if(o=s[i][0],b=(v=t.util.$$('[name="'+o+'"]',r)).length)if(1===b)a=v[0];else for(var y=0,M=void 0;y<b;y++)if((M=v[y]).value===n){a=M;break}if(u="=",a)if(k=e.util.data(a,"nb-json"),t.util.isPlainObject(k)&&!t.util.isEmpty(k))if("values"in k){var j=k.values[n];for(var S in k.selectors)t.util.hasOwn(k.selectors,S)&&l(S,j[k.selectors[S]])}else Array.isArray(k.selectors)?k.selectors.forEach((function(t){l(t.split(u),u)})):k.selectors&&l(k.selectors.split(u),u);else l(o,n,u);else b>1&&t.util.includes(n,"|")&&l(o,n,u)}h=n,c=o,p=v,g=b,d=a,f=u,m=k},a=0,h=void 0,c=void 0,f=void 0,d=void 0,p=void 0,g=void 0,m=void 0;a<n;a++)u(a,h,c,f,d,p,g,m);if(i=[],!t.util.isEmpty(o))for(var v in o)t.util.hasOwn(o,v)&&i.push(v+o[v].join("|"))}}else i=[i];this.selectors&&i.push(this.selectors),this.initQuery=!1,this.start=this.init,this.total=0,this.variables.selectors=i.join(","),this.variables.start=this.start,t.util.html(this.$el,""),this.request()},parse:function(){var e;for(var i in this.response)if(t.util.hasOwn(this.response,i)&&(e=this.response[i],Array.isArray(e)?(this.config.query=i,this.items=e,this.count=e.length):"getTotal"===i&&(this.total=e),this.count&&this.total))break},renderItems:function(e){t.util.isUndefined(e)&&(e=this.items);var i=window;if(t.util.includes(this.render,"."))for(var r=this.render.split("."),s=r.length,n=0;n<s;n++)i=i[r[n]];else i=i[this.render];return t.util.isFunction(i)&&Array.isArray(e)?i.call(this,e,this.config):(this.status=500,"")},request:function(){e.util.profilerStart("NBkit.Json.request");var i=this.$el,r=t.util.$(".nb-json-more",i);this.count=0,this.remaining=0,t.util.remove(".uk-alert",i),r||(r=t.util.$(e.util.wrap(e.util.wrap(this.loadMore,{type:"button",class:this.clsMoreButton},"button"),this.clsMore)),t.util.append(i,r)),r.style.display="";var s=t.util.$("button",r);t.util.attr(s,"disabled",!0),t.util.html(s,t.util.html(s).replace(this.loadMore,e.util.ukSpinner(.467))),this.variables.start=this.start,this.initQuery||(this.initQuery=!0,t.util.trigger(i,"initQuery",this));var n=this;e.util.graphql(this.query,this.variables).then((function(o){if(n.status=o.status,n.response=o.response,n.response){t.util.removeAttr(s,"disabled");var l=t.util.$(".uk-spinner",s);if(l&&(t.util.before(l,n.loadMore),t.util.remove(l)),n.parse(),n.remaining=n.total?n.total-n.start-n.count:-1,n.message){var u=t.util.$(".nb-json-message",i);u||(u=t.util.$(e.util.wrap("","nb-json-message uk-margin-top uk-margin-bottom")),t.util.prepend(i,u));var a=n.message.replace("{count}",n.count+n.start-n.init).replace("{total}",n.total-n.init);t.util.html(u,"jsonMessage"in window?jsonMessage(a):e.util.ukAlert(a,"primary"))}n.count?(t.util.before(r,n.renderItems()),t.util.trigger(i,"render",n)):(n.errors=[n.noResults],n.status=404,t.util.trigger(i,"error",n)),n.remaining<=0||!n.count||!n.loadMore?r.style.display="none":n.start=n.start+n.count,t.util.trigger(i,"complete",n)}else t.util.trigger(i,"error",n);e.util.profilerStop("NBkit.Json.request")}),(function(r){n.status=r.status,n.errors=r.response,t.util.trigger(i,"error",n),e.util.profilerStop("NBkit.Json.request")}))}}})}));
